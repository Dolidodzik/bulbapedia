{% load static %}
<html>
    <head>
        <title>Bulbapedia</title>
        <link rel="stylesheet" href="{% static 'css/main.css' %}">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        {% block head %}
        {% endblock %}
    </head>
    <body>

      <div class="top-bar">
        <form onsubmit="redirect()" action="javascript:void(0);">
          <input id="search_query" type="text" placeholder="Search for some creature here!">
          <input type="submit" value="Search!">
        </form>
        <a href="/"> Back to home </a> <br/><br/>
        <button class="open-button" onclick="OpenForm()"> Advanced Search </button>

        <iframe width="0" height="0" border="0" name="dummyframe" id="dummyframe"></iframe>

        <form class="form-container" id="advanced_search_form" action="/" target="dummyframe">{% csrf_token %}
          {{form.as_p}}
          <button type="submit">Submit</button> <br/>
          <button type="button" onclick="CloseForm()"> Close </button> <br/>
          <a href="/advanced_search"> Advanced Search - separate page </a>
        </form>

        <div id="results">
        </div>

      </div>

      <div class="container">
        {% block content %}
        {% endblock %}
      </div>

      <script>
        function redirect(){
          window.open("/search/" + document.getElementById("search_query").value, '_blank');
        }
        function CloseForm(){
          document.getElementsByClassName("form-container")[0].style.display = "none";
        }
        function OpenForm(){
          if (document.getElementsByClassName("form-container")[0].style.display == "block"){
            document.getElementsByClassName("form-container")[0].style.display = "none";
          }else{
            document.getElementsByClassName("form-container")[0].style.display = "block"
          }
        }

        $.ajaxSetup({
          beforeSend: function(xhr, settings) {
          function getCookie(name) {
             var cookieValue = null;
             if (document.cookie && document.cookie != '') {
                 var cookies = document.cookie.split(';');
                 for (var i = 0; i < cookies.length; i++) {
                     var cookie = jQuery.trim(cookies[i]);
                     if (cookie.substring(0, name.length + 1) == (name + '=')) {
                         cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                         break;
                    }
                 }
             }
             return cookieValue;
           }
           xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
         }
        });

        $("#advanced_search_form").submit(function(event){
          /* Getting input values */
          formData = []
          /* i = 1, because [0] is hidden input, it shouldn't be used to search in databse */
          for(let i=1; i < event.target.length; i++){
            /* Ignore all elements, that aren't input[type="text"] */
            if(event.target[i].type == "text"){
              formData.push(event.target[i].value);
            }
          }

          $.ajax({
            url: "http://localhost:8000",
            method: "post",
            data: {
              formData: formData
            },
            success: function (response) {
              if(response.results[0]){
                let results = JSON.parse(response.results[0]);
                let inner = '';
                results.forEach(element => {
                  console.log(element.fields.Breed_name);
                  inner += '<br/>  <a href="/creature/'+element.fields.Breed_name+'/" target="_blank"> '+element.fields.Breed_name+' </a>'
                });
                console.log(inner)
                document.getElementById("results").innerHTML = inner
              }else{
                document.getElementById("results").innerHTML = '<b style="color: white;">Nothing found! Try other search query!</b>'
              }

            },
            error: function(jqXHR, textStatus, errorThrown) {
               console.log(textStatus, errorThrown);
            }
          });

          event.preventDefault();
        });
      </script>
    </body>
</html>
